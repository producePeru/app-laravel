<?php

namespace App\Http\Controllers\Download;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use PhpOffice\PhpSpreadsheet\IOFactory;
use Symfony\Component\HttpFoundation\StreamedResponse;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;


class QuestionnarieController extends Controller
{
    public function questionsAnswersAdvisorsFormalizations()
    {
        try {

            $user = auth()->user();

            if ($user->rol != 1) {
                return response()->json([
                    'message' => 'No tienes permiso para realizar esta acciÃ³n',
                    'status'  => 500
                ]);
            }

            $items = DB::table('questions_answers')
                ->join('users', 'questions_answers.user_id', '=', 'users.id')
                ->select(
                    'questions_answers.*',
                    'users.name as asesor_name',
                    'users.lastname as asesor_lastname'
                )
                ->orderBy('questions_answers.created_at', 'desc')
                ->get(); // ðŸ‘ˆ 

            $rows = $items->map(function ($item, $index) {
                return [
                    'NÂ°' => $index + 1,
                    'Pregunta' => $item->question,
                    'Respuesta' => $item->answer,
                ];
            });

            $templatePath = storage_path('app/plantillas/cuestionario_formalizaciones_av.xlsx');

            $spreadsheet = IOFactory::load($templatePath);

            $sheet = $spreadsheet->getActiveSheet();

            $startRow = 2;

            foreach ($rows as $i => $row) {
                $col = 'A';
                foreach ($row as $value) {
                    $sheet->setCellValue("{$col}" . ($startRow + $i), $value);
                    $col++;
                }
            }

            // âœ… CORRECTO: solo este return
            return new StreamedResponse(function () use ($spreadsheet) {
                $writer = new Xlsx($spreadsheet);
                $writer->save('php://output');
            }, 200, [
                'Content-Type'        => 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'Content-Disposition' => 'attachment; filename="postulantes-feria.xlsx"',
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'message' => 'Error al exportar: ' . $e->getMessage(),
                'status' => 500
            ], 500);
        }
    }
}
